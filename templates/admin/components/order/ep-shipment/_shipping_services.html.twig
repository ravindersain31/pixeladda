<div class="mt-2 border-top" data-loading="action(deleteParcels)|hide">
    {% set firstShipment = orderShipments | first %}
    {% if firstShipment.trackingId is null %}
        <div class="mb-3">
            <label for="shippingService" class="h5 mt-2">Shipping Service</label>
            {% if firstShipment.rates | length <= 0 %}
                <div class="alert alert-warning p-2">
                    No shipping options are available for this order.
                    This could be due to the parcel being too heavy or too large for the available services.
                </div>
            {% endif %}
            {% set preferredShippings = preferredShipping.get(firstShipment.rates, order) %}
            <div class="input-group">
                <select class="form-select rounded" id="shippingService" name="shippingService"
                        data-model="shippingRateId"
                        data-value="{{ shippingRateId }}" data-loading="action(reloadRates)|addAttribute(disabled)">
                    <option value="">-- Select Shipping Service --</option>
                    {% for groupName, group in preferredShippings.options %}
                        {% if group.rates is defined and group.rates | length > 0 %}
                            <optgroup label="{{ group.title }}">
                                {% for rate in group.rates %}
                                    <option value="{{ rate.id }}" {% if rate.id == shippingRateId %}selected{% endif %}>
                                        {% if groupName == 'Preferred' %}
                                            {% if rate.carrier == 'UPSDAP' %}
                                                UPS
                                            {% else %}
                                                {{ rate.carrier }}
                                            {% endif %}-
                                        {% endif %}
                                        {{ rate.service }}
                                        (${{ rate.rate }}{% if rate.est_delivery_days %}
                                        - Est. Delivery: {{ rate.est_delivery_days }} days{% endif %})
                                    </option>
                                {% endfor %}
                            </optgroup>
                        {% endif %}
                    {% endfor %}
                </select>
                <div class="input-group-append p-2">
                    <button class="btn btn-primary btn-sm" data-action="live#action"
                            data-live-action-param="reloadRates"
                            data-live-batch-param="{{ batch }}"
                            data-loading="action(reloadRates)|addAttribute(disabled)">
                        <span data-loading="action(reloadRates)|show" style="display: none">
                            <i class="fa fa-refresh fa-spin"></i>
                        </span>
                        <span data-loading="action(reloadRates)|hide" style="display: block">
                            <i class="fa fa-refresh"></i>
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <div class="d-block">
            <button data-action="live#action"
                    data-live-action-param="buyLabel"
                    data-live-batch-param="{{ batch }}"
                    data-loading="action(buyLabel)|action(reloadRates)|addAttribute(disabled)"
                    class="btn btn-primary d-block mt-2">
                <span data-loading="action(buyLabel)|show" style="display: none">Purchasing Label...</span>
                <span data-loading="action(buyLabel)|hide" style="display: block">Purchase Label</span>
            </button>
            <span data-loading="action(buyLabel)|show" class="mt-2" style="display: none">
                This may take longer, don't refresh the page.
            </span>
        </div>
    {% endif %}
</div>