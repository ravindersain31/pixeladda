{% extends 'base.html.twig' %}

{% block title %}Order #{{ order.orderId }} - {{storeInfo.storeTitle}}{% endblock %}
{% block javascripts %}
    <script src="https://js.braintreegateway.com/web/dropin/1.39.1/js/dropin.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.97.3/js/client.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.97.3/js/google-payment.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.97.3/js/apple-pay.min.js"></script>
    <script src="https://pay.google.com/gp/p/js/pay.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApxy-puRWe0-tyK_eH-1NjadBfucNNmks&loading=async&libraries=places"></script>
{% endblock %}
{% block body %}
    <div class="page-header">
        <div class="page-header-content order-view">
            {% if order.status in ['RECEIVED', 'PROOF_UPLOADED', 'CHANGES_REQUESTED', 'DESIGNER_ASSIGNED'] %}
                Approve Your Proof
            {% else %}
                Thank You for Choosing <span class="break-mobile">{{ storeInfo.storeName }}!</span>
            {% endif %}
        </div>
    </div>

    {% set user = order.user %}
    {% set approvedProof = order.approvedProof %}
    <div class="container my-2 order-conformation order-details">
        {{ include('common/flash.html.twig') }}
        <div class="row mb-2">
            <div class="col-12 col-md-9">
                <h5 class="lead">
                    Order #<a class="d-inline-block" href="{{ url('order_view', { oid: order.orderId }) }}">
                        <strong class="text-success">{{ order.orderId }}</strong>
                    </a>
                </h5>
                <h5 class="lead mb-1">Total Amount: <strong>${{ order.totalAmount | number_format(2) }}</strong></h5>
                <p class="small mb-2">Order Date: {{ order.orderAt | date("F jS, Y \\a\\t g:ia") }}</p>
            </div>
            <div class="col-12 col-md-3 text-right d-flex align-items-center justify-content-center justify-content-md-end">
                <div class="actions d-flex flex-column">
                    <a href="{{ url('order_view', {oid: order.orderId}) }}"
                       class="btn btn-info mb-2 btn-sm d-flex justify-content-center align-items-center text-white text-nowrap"
                       target="_blank">
                        View Order Details
                        <i data-feather="external-link" width="14px" class="ms-1 text-white"></i>
                    </a>
                    {% if order.status in ['RECEIVED', 'PROOF_UPLOADED', 'CHANGES_REQUESTED', 'DESIGNER_ASSIGNED'] %}
                        <a href="{{ url('order_view', {oid: order.orderId}) }}"
                           class="btn btn-warning btn-sm d-flex justify-content-center align-items-center"
                           data-bs-toggle="offcanvas" data-bs-target="#update-address"
                           aria-controls="offcanvasRight">
                            Update Address
                            <i data-feather="edit" width="14px" class="text-dark ms-1"></i>
                        </a>
                        {% include 'account/order/_update_address.html.twig' %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% if order.status in ['CANCELLED'] %}
            <div class="alert alert-warning text-center mb-2">
                This order has been cancelled
                {% if order.paymentStatus in ['REFUNDED', 'PARTIALLY_REFUNDED'] %}
                    and all associated payments have been refunded to the original payment method.
                {% else %}
                    .
                {% endif %}
                </br>For questions please call <a href="tel: +1-877-958-1499">+1-877-958-1499</a> or email <a href="mailto: {{storeInfo.storeSupportEmail}}">{{storeInfo.storeSupportEmail}}</a>.
            </div>
        {% endif %}
        {% include 'account/order/_order_items_table.html.twig' %}
        {% if order.status == 'CHANGES_REQUESTED' %}
            <div class="alert alert-info my-3 text-center">
                We have received the requested changes. Our Design Team will update and send you a new proof for your
                review today.
            </div>
        {% endif %}
        {{ include('account/order/_order_proofs_approve_change_buttons.html.twig') }}
        <div class="proofs_approval">
            <div class="accordion" id="proofsAccordion">

                {% set changeCount = messages|filter(message => message.type == 'CHANGES_REQUESTED')|length + 1 %}
                {% set proofCount = messages|filter(message => message.type == 'PROOF')|length + 1 %}
                {% set changeCount = changeCount < proofCount ? proofCount : changeCount %}

                {% if messages|length > 0 %}
                    {% for message in messages %}

                        {% set messageIsChangeRequest = message.type == 'CHANGES_REQUESTED' %}
                        {% set messageIsProof = message.type == 'PROOF' %}
                        {% set changeCount = messageIsChangeRequest ? changeCount - 1 : changeCount %}
                        {% set proofCount = messageIsProof ? proofCount - 1 : proofCount %}
                        {% set changeCount = messageIsProof ? proofCount : changeCount %}

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="proof_heading_{{ message.id }}">
                                <button class="accordion-button d-block {{ loop.first and order.status in ['RECEIVED', 'PROOF_UPLOADED', 'CHANGES_REQUESTED', 'DESIGNER_ASSIGNED'] ? '' : 'collapsed' }} {{ approvedProof is not null and approvedProof == message ? 'bg-success approved-proof' : '' }}"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#proof_collapse_{{ message.id }}"
                                        aria-expanded="{{ loop.first ? 'true' : 'false' }}"
                                        aria-controls="proof_collapse_{{ message.id }}">
                                    <small class="float-start">
                                        {% if message.type == 'CHANGES_REQUESTED' %} Your Feedback on Proof {% else %} {{ message.type | replace({'_': ' '}) | capitalize }} {% endif %}
                                        #{{ message.type == 'CHANGES_REQUESTED' ? changeCount : proofCount }}
                                        {% if approvedProof is not null and approvedProof == message %}
                                            <span>(Approved)</span>
                                            {{ order.proofApprovedAt | date('l, M d, Y h:i A') }}
                                        {% endif %}
                                    </small>
                                    <span class="float-end">
                                        <small class="text-small">
                                            <small class="text-small">{{ message.sentAt | date('l, M d, Y h:i A') }}</small>
                                        </small>
                                    </span>
                                    <span class="clearfix"></span>
                                </button>
                            </h2>
                            <div id="proof_collapse_{{ message.id }}"
                                class="accordion-collapse collapse {{ loop.first or loop.index == 2 and order.status in ['CHANGES_REQUESTED'] ? 'show' : '' }} {{ loop.first and order.status in ['RECEIVED', 'PROOF_UPLOADED', 'DESIGNER_ASSIGNED', 'PROOF_APPROVED'] ? 'show' : '' }}"
                                aria-labelledby="proof_heading_{{ message.id }}"
                                data-bs-parent="#proofsAccordion">
                                <div class="accordion-body">
                                    {% for key,file in message.files %}
                                        {% if file.type not in ['CUT_FILE'] %}
                                            <div class="text-center mb-2 {% if key == 1 %} pb-3 border-bottom {% endif %} ">
                                                {% if file.type == 'PROOF_IMAGE' %}
                                                    <img src="{{ vich_s3.asset(file, 'fileObject', '7000') }}"
                                                        alt="Proof Image {{ loop.index }}"
                                                        class="img-fluid mb-2 d-block m-auto">
                                                {% elseif file.type == 'PROOF_FILE' %}
                                                    <a href="{{ vich_s3.asset(file, 'fileObject') }}"
                                                    class="btn btn-sm btn-info my-2" target="_blank">
                                                        Download Proof File
                                                    </a>
                                                {% else %}
                                                    <a href="{{ vich_s3.asset(file, 'fileObject') }}"
                                                    class="btn btn-sm btn-primary" target="_blank">
                                                        View File {{ loop.index }}
                                                    </a>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    <p class="">{{ message.content|raw }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% elseif order.needProof == false and order.isCanvasConverted %}
                    <div class="text-center mb-2">
                        <a href="{{ storeBasedUrl(url('order_auto_generated_proof', {orderId: order.orderId, withCustomerDesign: 1}), order.storeDomain) }}"
                           class="btn btn-sm btn-info-v2 my-2" target="_blank">
                            Download Proof File
                        </a>
                    </div>
                {% endif %}
            </div>
            {% if approvedProof is null %}
                {% if order.status == 'PROOF_UPLOADED' %}
                    <div class="collapse" id="request-changes-component-collapse">
                        <div class="request-changes-component">
                            {{ component('RequestChangeForm', {
                                form: form,
                                order: order,
                                data: data,
                            }) }}
                        </div>
                    </div>
                {% elseif order.status == 'RECEIVED' or order.status == 'DESIGNER_ASSIGNED' %}
                    <div class="alert alert-info text-center mt-2">
                        We're preparing the proof design for your order. We will send you an email when the proof design
                        is uploaded.
                    </div>
                {% endif %}
            {% endif %}
            {{ include('account/order/_order_proofs_approve_change_buttons.html.twig') }}
        </div>
    </div>
    <div class="mt-2 mt-md-4">
        {{ include("common/_coupon_banner.html.twig") }}
        {{ include('common/_people_also_purchase_swiper.html.twig') }}
    </div>
{% endblock %}
